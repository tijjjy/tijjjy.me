<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  

  <title>
    
      Securing Web Apps With Authelia &middot; Tijjjy Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Tijjjy Blog" />
</head>


  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="/">
          <h2 class="nav-title">Tijjjy Blog</h2>
        </a>
        <ul class="nav-social-icons">
          
          
            <li><a target="_blank" href="https://github.com/tijjjy"><i class="fab fa-github"></i></a></li>
          
          
          
        </ul>
      </div>
    </nav>

    <main>
      <div class="post">

  <div class="post-info">
    
      <time datetime="2023-01-23 00:00:00 +0800">January 23, 2023</time>
    
  </div>
  <h1 class="post-title">
    <div>Securing Web Apps With Authelia</div>
  </h1>

  <h1 id="introduction">Introduction</h1>
<p>Welcome to another blog post, today I’m going to show you how to secure web applications with Authelia!</p>

<p>Authelia intregrates into many common reverse proxies to add authentication in front of web applications, for example you have a website that you want to implement multi-factor authentication in front of it, Authelia has you covered. Authelia supports single factor and multi-factor, allowing you to authenticate with a one time passcode or even a yubikey!</p>

<p>The reverse proxy I will be using to setup Authelia with will be Traefik as it is a easy to configure and fast reverse proxy.</p>

<p>For this demonstration and walkthrough I will be using Ubuntu 22.04 on a 1vcpu 1GB Memory VPS hosted on <a href="https://www.binarylane.com.au/">www.binarylane.com.au</a>. I highly recommened BinaryLane as they provide fast and reliable VPS solutions and even dedicated servers!</p>

<h1 id="prerequisites">Prerequisites</h1>
<ul>
  <li>Linux Server</li>
  <li>Docker</li>
  <li><a href="https://github.com/tijjjy/Authelia-Traefik-Docker">https://github.com/tijjjy/Authelia-Traefik-Docker</a>]</li>
  <li>Ports 80,443 TCP Open</li>
  <li>DNS Record for Authelia sub-domain</li>
  <li>DNS Record for web application</li>
</ul>

<h1 id="setting-the-dns-record">Setting the DNS Record</h1>
<p>Before we configure Authelia, we need to create a DNS record point to our server so that we can request a certificate from letsencrypt.</p>

<p>Log into your Domain registrar and create an A record for the domain you want to use such as derp01.example.com thats points to the IP address of your server.</p>

<p>For example:</p>
<ul>
  <li>auth.example.com</li>
  <li>A Record</li>
  <li>1.1.1.1 (Using your own servers IP address of course)</li>
</ul>

<p>Once set, confirm the domain resolves to the IP address by running,</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dig auth.example.com
</code></pre></div></div>
<p>OR</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nslookup auth.example.com
</code></pre></div></div>
<p>Either command should return the IP address of your server.</p>

<p>Repeat the previous steps for your web applications domain.</p>

<h1 id="installing-requirements">Installing Requirements</h1>
<p>To get started lets update the system which on Ubuntu can be done with the following commands.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt upgrade <span class="nt">-y</span>
</code></pre></div></div>
<p>After the upgrades are installed it’s always best to reboot the server to reload into the latest linux kernel.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>reboot
</code></pre></div></div>
<p>Once your server is fully updated and finished rebooting, lets go and install Docker and Git</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>docker docker-compose git <span class="nt">-y</span>
</code></pre></div></div>
<p>If you have trouble installing docker, you can find instructions for the linux distribution you are using at the official docker docs. <a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install</a></p>

<h1 id="cloning-the-repository">Cloning the Repository</h1>
<p>With all the requirements installed, lets go ahead and clone my repository that contains all files and configuration we need to get started.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /opt
git clone https://github.com/tijjjy/Authelia-Traefik-Docker authelia
<span class="nb">cd </span>authelia
<span class="nb">ls</span> <span class="nt">-lah</span>
</code></pre></div></div>
<p>If done correctly you should see the following</p>

<p><img src="/images/posts/securewebappswithauthelia/picture1.png" alt="ls directory" /></p>

<h1 id="configuration">Configuration</h1>

<h2 id="traefik-configuration">Traefik Configuration</h2>
<p>There are a few sections within the config files that we need to change.</p>

<p>First open docker-compose.yml</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano docker-compose.yml
</code></pre></div></div>
<p>Change the environment variable TZ in section for Authelia to your own timezone.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture2.png" alt="Authelia Timezone" /></p>

<p>Now open the traefik config file</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/traefik/traefik.toml
</code></pre></div></div>
<p>At this point we only need to change 3 sections of the traefik config file.</p>

<p>Go to the AUTHELIA ROUTER section in the http.routers section and change line</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule = "Host(`auth.example.com`)"
</code></pre></div></div>
<p>to the domain you want to use for Authelia, for this demo I will use,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule = "Host(`auth.tijjjy.me`)"
</code></pre></div></div>

<p><img src="/images/posts/securewebappswithauthelia/picture3.png" alt="Authelia Host" /></p>

<p>Next, go to the #MIDDLEWARES section to the address line and change</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>address = "http://authelia:9091/api/verify?rd=https%3A%2F%2Fauth.example.com%2F"
</code></pre></div></div>
<p>to</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>address = "http://authelia:9091/api/verify?rd=https://auth.tijjjy.me"
</code></pre></div></div>

<p><img src="/images/posts/securewebappswithauthelia/picture4.png" alt="Authelia Middleware Address" /></p>

<p>Lastly, change the email line at the #letsencrypt section to your email that you want to use to register the certificate with letsencrypt.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture5.png" alt="letsencrypt email" /></p>

<p>Cool, thats it for the the traefik config file for now, let’s move on to the Authelia config file.</p>

<h2 id="authelia-configuration">Authelia Configuration</h2>
<p>A default reference template of the Authelia configuration can be found at the Authelia github which outlines every possible configuration available.<br />
<a href="https://github.com/authelia/authelia/blob/master/config.template.yml">https://github.com/authelia/authelia/blob/master/config.template.yml</a></p>

<p>Before we edit the Authelia config file we need to generate a few random secure strings, run this command 3 times to generate 3 strings.</p>

<p>You can find more information on random alphanumeric strings at the Authelia docs.<br />
<a href="https://www.authelia.com/reference/guides/generating-secure-values/#generating-a-random-alphanumeric-string">Generating-a-random-alphanumeric-string</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run authelia/authelia:latest authelia crypto rand <span class="nt">--length</span> 64 <span class="nt">--charset</span> alphanumeric
</code></pre></div></div>
<p>You should see output similar if successful. Take note of the output.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture6.png" alt="secure random strings" /></p>

<p>Now open the Authelia config file,</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/authelia/configuration.yml
</code></pre></div></div>

<p>Replace the variable jwt_secret with the first secure string you generated.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture7.png" alt="jwt_secret" /></p>

<p>Replace the default_redirection_url variable with the domain you are using for Authelia.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture8.png" alt="default_redirection_url" /></p>

<p>Next go down to the Session Provider Configuration section and change the secret variable to the second secure string you generated and replace the domain variable to the apex or root domain you are using, for me that is tijjjy.me.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture9.png" alt="session" /></p>

<p>Next go to the Storage Provider Configuration section and change the encryption_key variable to the 3rd secure random string you generated.<br />
<img src="/images/posts/securewebappswithauthelia/picture11.png" alt="encryption_key" /></p>

<p>That’s it for the configuration for now. Well Done!</p>

<h2 id="creating-an-authelia-user">Creating an Authelia User</h2>
<p>More information on generating passwords for users can be found at the Authelia docs.<br />
<a href="https://www.authelia.com/reference/guides/passwords/#passwords">https://www.authelia.com/reference/guides/passwords/#passwords</a></p>

<p>It’s time to create our first user so we can login to our Authelia instance, we will be using the pbkdf2 hashing algorithm to generate our password, lets go ahead and run the command to create our password. Remember to change the ‘password’ argument to the password you want to use!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run authelia/authelia:latest authelia crypto <span class="nb">hash </span>generate pbkdf2 <span class="nt">--password</span> <span class="s1">'password'</span>
</code></pre></div></div>

<p>Now that we have our password hash we want to use, let’s open the users_database.yml file and create our user.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/authelia/users_database.yml
</code></pre></div></div>
<p>Replace “authelia-demo” with the username you want to use, I will use “tijjjy”.<br />
Replace “displayname” with your desired display name.<br />
Replace “password” with the password hash you just generated.<br />
And finally, replace “email” with the email you want to use for the your user.</p>

<p>Your users file should look something like this,</p>

<p><img src="/images/posts/securewebappswithauthelia/picture10.png" alt="default_redirection_url" /></p>

<p>We now have our user all setup and ready to go!</p>
<h1 id="first-time-start-up">First Time Start-Up</h1>
<p>All of our initial configuration should be complete, lets go ahead and start out containers.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Let’s go ahead now and open your preferred browser and navigate to https://auth.domain.com replacing auth.domain.com with the domain you set for Authelia.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture12.png" alt="Authelia Homepage" /></p>

<p>You should see the Authelia homepage, go ahead and login with the user you created, you will be prompted to setup OTP multi-factor authentication.</p>

<p>One you click on the register button for OTP, open the following file which will contain the initial link to register multi-factor authentication,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/authelia/notification.txt
</code></pre></div></div>

<p>Once you have setup multi-factor authentication, let’s go ahead and add our first web application to Traefik and Authelia!</p>

<h1 id="adding-our-first-web-application">Adding Our First Web Application</h1>
<p>Open the Traefik config file,</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/traefik/traefik.toml
</code></pre></div></div>

<p>Navigate down to the services section and add the following,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[http.services.webapp]
  [http.services.webapp.loadBalancer]
    [[http.services.webapp.loadBalancer.servers]]
      url = "http://whoami:2001/"
</code></pre></div></div>
<p>Replacing the each reference to webapp with the name you want for the service
Replacing the “url” with the url or address of the web application you want to protect, since I’m protecting another container in the same network, I can just put the container name and it’s port.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture13.png" alt="webapp" /></p>

<p>Now lets add the http router, go to the http.routes section and add the following,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[http.routers.webapp]
  entryPoints = ["https"]
  rule = "Host(`webapp.tijjjy.me`)"
  middlewares = ["authelia"]
  service = "webapp"
  [http.routers.webapp.tls]
    certResolver = "letsencrypt"
</code></pre></div></div>
<p>Once again replacing “webapp” with the name you want to call the router.</p>

<p>Make sure for the service line, to add the name of the service that you gave your web application, in my case it was “webapp”.</p>

<p>Replace the line,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rule = "Host(`webapp.domain.com`)"
</code></pre></div></div>
<p>With the domain name you want for your web applications. Make sure the domain name is set correctly in your DNS registrar!!!</p>

<p>It should look something like this,</p>

<p><img src="/images/posts/securewebappswithauthelia/picture14.png" alt="webapp http router" /></p>

<p>Now lets open the Authelia configuration and add our web application.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano data/authelia/configuration.yml
</code></pre></div></div>

<p>Go to the rules section, and replace the default rule with your the domain of the web application you added to Traefik, it should look like this.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture15.png" alt="Authelia webapp" /></p>

<h1 id="accessing-protected-web-application">Accessing Protected Web Application</h1>
<p>Epic, we should be all set and ready to restart our containers and login to our newly protected web application. Let’s go ahead and restart our containers. Make sure to save your configurations!</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose down
docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>Open your preferred browser and navigate to the URL for your web application, for me it is https://webapp.tijjjy.me</p>

<p>As you can see by the URL, we have been redirected back to Authelia and asked to login, let’s do that.</p>

<p><img src="/images/posts/securewebappswithauthelia/picture16.png" alt="Authelia webapp accessing" /></p>

<p>Once logged in you will now be accessing your protected web application!!!</p>

<p><img src="/images/posts/securewebappswithauthelia/picture17.png" alt="Authelia webapp accessing" /></p>

<h1 id="end">End</h1>

<p>Awesome work, you are now protecting your web application, you can go ahead and add more web applications to Authelia and Traefik to protect even more services. I definitely encourge you to check out the Authelia and Traefik documention on how to do even more advanced configurations.</p>

<p>I hope you enjoyed this walkthrough and learned how easy it is to protected web applications with Authelia.</p>

<p>Thanks for reading!</p>

<h1 id="links">Links</h1>
<ul>
  <li>BinaryLane <a href="https://www.binarylane.com.au/">www.binarylane.com.au</a></li>
  <li>Github <a href="https://github.com/tijjjy">https://github.com/tijjjy</a></li>
  <li>Github Repository <a href="https://github.com/tijjjy/Authelia-Traefik-Docker">https://github.com/tijjjy/Authelia-Traefik-Docker</a></li>
  <li>Authelia <a href="https://www.authelia.com/">https://www.authelia.com</a></li>
  <li>Traefik <a href="https://doc.traefik.io/traefik/">https://doc.traefik.io/traefik</a></li>
</ul>


</div>

<div class="relatedPosts">

  
    
    
    
    

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

    
  

</div>

    </main>

    <footer>
      <span>
        &copy; <time datetime="2023-01-23 21:45:54 +0800">2023</time> Tijjjy. Powered by Jekyll and <a href="#">Rain</a> theme.
      </span>
    </footer>
  </body>
</html>
